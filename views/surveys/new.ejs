<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>새 설문조사 만들기</title>
    <style>
        .question {
            margin-bottom: 20px;
        }
        .option {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>새 설문조사 만들기</h1>
    <form action="/survey" method="POST">
        <label for="title">설문조사 제목:</label>
        <input type="text" name="title" required>
        
        <h2>문항 추가</h2>
        <div id="questions"></div> <!-- 처음에는 빈 상태로 시작 -->

        <button type="button" onclick="addQuestion()">문항 추가</button>
        <button type="submit">설문조사 만들기</button>
    </form>

    <script>
      let questionCount = 0; // 문항 개수 카운트
  
      // 문항 HTML 구조를 반환하는 함수
      function createQuestionHTML(index) {
          return `
              <div class="question">
                  <button type="button" onclick="moveQuestion(this, 'up')">↑</button>
                  <button type="button" onclick="moveQuestion(this, 'down')">↓</button>
                  <input type="text" name="questions[${index}][questionText]" placeholder="문항 내용" required>
                  <input type="text" name="questions[${index}][questionDescription]" placeholder="문항 설명">
                  <label>
                      <input type="checkbox" name="questions[${index}][isRequired]" value="true"> 필수
                  </label>
                  <select name="questions[${index}][questionType]" onchange="updateQuestionFields(this)">
                      <option value="short_answer">단답형</option>
                      <option value="long_answer">장문형</option>
                      <option value="single_choice">단일 선택</option>
                      <option value="multiple_choice">다중 선택</option>
                      <option value="date">날짜 입력</option>
                      <option value="dropdown">드롭다운 선택</option>
                      <option value="preference">선호도</option>
                      <option value="reservation">날짜 예약</option>
                  </select>
                  <div class="options" style="display: none;">
                      <div class="option">
                          <input type="text" name="questions[${index}][options][]" placeholder="선택지 입력">
                          <button type="button" onclick="removeOption(this)">삭제</button>
                      </div>
                      <button type="button" onclick="addOption(this)">선택지 추가</button>
                  </div>
                  <div class="allow-other" style="display: none;">
                      <label>
                          <input type="checkbox" name="questions[${index}][allowOther]" value="true"> 기타 응답 수집
                      </label>
                  </div>
                  <div class="textarea" style="display: none;">
                      <label>답변:</label>
                      <textarea name="questions[${index}][answer]" rows="4" placeholder="답변 입력"></textarea>
                  </div>
                  <div class="date" style="display: none;">
                      <label>날짜 입력:</label>
                      <input type="date" name="questions[${index}][date]" placeholder="날짜 입력">
                  </div>
                  <div class="short-answer" style="display: none;">
                      <label>단답형 답변:</label>
                      <input type="text" name="questions[${index}][prefixText]" placeholder="앞에 붙일 텍스트" value="${questions.prefixText || ''}">
                      <input type="text" name="questions[${index}][shortAnswer]" placeholder="단답형 답변 입력">
                      <input type="text" name="questions[${index}][suffixText]" placeholder="뒤에 붙일 텍스트" value="${questions.suffixText || ''}">
                      <select name="questions[${index}][inputType]" onchange="updateInputType(this)">
                          <option value="all">모든 값</option>
                          <option value="letters">영문자만 입력</option>
                          <option value="integer">정수만 입력</option>
                      </select>
                      <div class="integer-range" style="display: none;">
                          <input type="number" name="questions[${index}][minValue]" placeholder="최소값">
                          <input type="number" name="questions[${index}][maxValue]" placeholder="최대값">
                      </div>
                  </div>
                  <div class="rank-limit" style="display: none;">
                      <label>최대 순위:</label>
                      <input type="number" name="questions[${index}][rankLimit]" min="1" placeholder="최대 순위 입력">
                  </div>
                  <div class="reservation" style="display: none;">
                      <label>시작 날짜:</label>
                      <input type="date" name="questions[${index}][reservation][startDate]" required>
                      <label>마감 날짜:</label>
                      <input type="date" name="questions[${index}][reservation][endDate]" required>
                      <label>최대 예약 인원:</label>
                      <input type="number" name="questions[${index}][reservation][maxParticipants]" required>
                      <label>예외 날짜 (쉼표로 구분):</label>
                      <input type="text" name="questions[${index}][reservation][exceptionDates]">
                  </div>
                  <button type="button" onclick="removeQuestion(this)">문항 삭제</button>
              </div>
          `;
      }

      // 문항 추가 함수
      function addQuestion() {
          const questionsDiv = document.getElementById('questions');
          questionsDiv.insertAdjacentHTML('beforeend', createQuestionHTML(questionCount));
          const newQuestionDiv = questionsDiv.lastElementChild;
          const newQuestionSelect = newQuestionDiv.querySelector('select');
          updateQuestionFields(newQuestionSelect); // 추가된 문항의 상태 업데이트
          questionCount++;
      }

      // 나머지 함수는 기존과 동일하게 유지
      function updateQuestionFields(select) {
        const questionDiv = select.closest('.question'); // question-content div로 접근
          const selectedValue = select.value;

          // 모든 추가 입력 필드 숨기기
          questionDiv.querySelector('.options').style.display = 'none';
          questionDiv.querySelector('.textarea').style.display = 'none';
          questionDiv.querySelector('.date').style.display = 'none';
          questionDiv.querySelector('.short-answer').style.display = 'none';

          // 선택한 유형에 따라 필드 보이기
          if (selectedValue === 'single_choice' || selectedValue === 'multiple_choice') {
              questionDiv.querySelector('.options').style.display = 'block';
              questionDiv.querySelector('.allow-other').style.display = 'block';
          } else if (selectedValue === 'long_answer') {
              questionDiv.querySelector('.textarea').style.display = 'block';
          } else if (selectedValue === 'date') {
              questionDiv.querySelector('.date').style.display = 'block';
          } else if (selectedValue === 'short_answer') {
              questionDiv.querySelector('.short-answer').style.display = 'block';
          } else if (selectedValue === 'dropdown') {
              questionDiv.querySelector('.options').style.display = 'block';
          } else if (selectedValue === 'preference') {
              questionDiv.querySelector('.options').style.display = 'block';
              questionDiv.querySelector('.rank-limit').style.display = 'block'; // 순위 제한 필드 보이기
          } else if (selectedValue === 'reservation') {
              questionDiv.querySelector('.reservation').style.display = 'block'; // 예약 필드 보이기
          }
      }

      function addOption(button) {
          const optionsDiv = button.parentElement;
          const questionDiv = optionsDiv.closest('.question'); // 현재 문항 div
          const questionIndex = Array.from(document.getElementById('questions').children).indexOf(questionDiv); // 질문 인덱스 추출
          const newOptionDiv = document.createElement('div');
          newOptionDiv.className = 'option';
          newOptionDiv.innerHTML = `
              <input type="text" name="questions[${questionIndex}][options][]" placeholder="선택지 입력">
              <button type="button" onclick="removeOption(this)">삭제</button>
          `;
          optionsDiv.insertBefore(newOptionDiv, button);
      }

      function updateInputType(select) {
          const questionDiv = select.closest('.question'); // 가장 가까운 질문 div 찾기
          const selectedValue = select.value;

          const integerRangeDiv = questionDiv.querySelector('.integer-range');

          // 모든 입력 필드 초기화
          integerRangeDiv.style.display = 'none';

          // 선택한 입력 유형에 따라 필드 보이기
          if (selectedValue === 'integer') {
              integerRangeDiv.style.display = 'block'; // 정수 범위 입력 필드 보이기
          }
      }

      function removeOption(button) {
          const optionDiv = button.parentElement;
          optionDiv.remove(); // 해당 선택지 삭제
      }

      function removeQuestion(button) {
          const questionDiv = button.parentElement;
          questionDiv.remove(); // 해당 문항 삭제
      }

      function moveQuestion(button, direction) {
          const questionDiv = button.parentElement; // 현재 문항 div
          const questionsDiv = document.getElementById('questions'); // 모든 문항 div

          // 현재 문항의 인덱스 찾기
          const index = Array.from(questionsDiv.children).indexOf(questionDiv);

          if (direction === 'up' && index > 0) {
              // 위로 이동
              questionsDiv.insertBefore(questionDiv, questionsDiv.children[index - 1]);
          } else if (direction === 'down' && index < questionsDiv.children.length - 1) {
              // 아래로 이동
              questionsDiv.insertBefore(questionDiv, questionsDiv.children[index + 2]);
          }
      }
    </script>
</body>
</html>
