<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#254B7A"> <!-- Android Chrome -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- iOS Safari -->
    
    <title>게시글 목록</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css"> <!-- CSS 파일 경로 -->

    <script>
        function confirmDelete() {
            return confirm("게시글을 삭제하시겠습니까?");
        }

        async function checkPermission(postId, category) {
            const response = await fetch(`/posts/${postId}?category=${category}`);
            if (response.status === 403) {
                alert('게시글 확인 권한이 없습니다.');
            } else if (response.ok) {
                // 조회수 증가 요청
                await fetch(`/posts/${postId}/incrementViews`, { method: 'POST' });
                
                // 조회수 업데이트
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                const viewsElement = postElement.querySelector('.views');
                const currentViews = parseInt(viewsElement.textContent.match(/\d+/)[0], 10);
                viewsElement.textContent = `(조회수: ${currentViews + 1})`;
                
                window.location.href = `/posts/${postId}?category=${category}`; // 권한이 있을 경우 게시글 상세 페이지로 이동
            } else {
                alert('게시글을 불러오는 중 오류가 발생했습니다.');
            }
        }
    </script>
</head>
<body>
    <%- include('../partials/navbar') %> 
    <%- include('../partials/bottom-navbar') %>

    <div class="container-fluid p-0" style="max-width: 960px; margin-bottom: 100px;">
        <h1><%= category ? `${allowedCategories[category]} 게시글 목록` : '전체 게시글 목록' %></h1>
        
        <% if (user && canWrite) { %>
            <a href="/posts/new?category=<%= category %>" class="btn btn-primary">새로 글쓰기</a>
        <% } %>
        
        <% if (user && user.role === 'superadmin') { %>
            <a href="/posts/settings/<%= category %>" class="btn btn-secondary">게시판 설정</a>
        <% } %>
        
        <ul>
            <% if (posts.length === 0) { %>
                <li>등록된 게시글이 없습니다.</li>
            <% } else { %>
                <% posts.forEach(post => { %>
                    <li data-post-id="<%= post._id %>">
                        <a href="javascript:void(0);" onclick="checkPermission('<%= post._id %>', '<%= post.category %>')">
                            [<%= allowedCategories[post.category] %>] <!-- 모든 사용자에게 카테고리 표시 -->
                            <%= post.title %> 
                            <span class="views" <% if (boardSetting && boardSetting.hideViews) { %>style="display:none;"<% } %>> 
                                (조회수: <%= post.views %>)
                            </span>
                            <span class="comments" <% if (boardSetting && boardSetting.hideCommentCount) { %>style="display:none;"<% } %>> 
                                (댓글 수: <%= post.commentCount %>)
                            </span>
                        </a>
                        <% if (!(boardSetting && boardSetting.hideAuthor)) { %>
                            - <%= post.author ? post.author.username : '작성자 없음' %>
                        <% } %>
                        <% if (!(boardSetting && boardSetting.hideDate)) { %>
                            - <%= post.createdAt.toDateString() %>
                        <% } %>
                        <% if (user && (user.role === 'superadmin' || (user.role === 'admin' && boardSetting.writePermission.includes('admin')))) { %>
                            <form action="/posts/delete/<%= post._id %>?category=<%= post.category %>" method="POST" style="display:inline;" onsubmit="return confirmDelete();">
                                <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                            </form>
                            <a href="/posts/edit/<%= post._id %>?category=<%= post.category %>" class="btn btn-warning btn-sm">수정</a>
                        <% } else if (user && user.id === post.author._id.toString()) { %>
                            <!-- 작성자일 경우 아무것도 표시하지 않음 -->
                        <% } %>
                    </li>
                <% }) %>
            <% } %>
        </ul>
    </div>
</body>
</html>
