<!DOCTYPE html>
<html>
<head>
    <title><%= post.title %></title>
    <script>
        function confirmPostDelete() {
            return confirm("게시글을 삭제하시겠습니까?");
        }

        function confirmCommentDelete() {
            return confirm("댓글을 삭제하시겠습니까?");
        }
    </script>
</head>
<body>
    <h1><%= post.title %></h1>
    <p>
        <% if (!(boardSetting && boardSetting.hideAuthor)) { %>
            작성자: <%= post.author.username %>
        <% } %>
    </p>
    <p>
        <% if (!(boardSetting && boardSetting.hideDate)) { %>
            작성일: <%= post.createdAt.toDateString() %>
        <% } %>
    </p>

    <p <% if (boardSetting && boardSetting.hideViews) { %>style="display:none;"<% } %>> 
        조회수: <%= post.views %>
    </p>    

    <p><%= post.content %></p>
    <% if (user && (user.role === 'admin' || user.role === 'superadmin' || user.id === post.author._id.toString())) { %>
        <form action="/posts/delete/<%= post._id %>?category=<%= category %>" method="POST" style="display:inline;" onsubmit="return confirmPostDelete();">
            <button type="submit">삭제</button>
        </form>
        <a href="/posts/edit/<%= post._id %>?category=<%= category %>">수정</a>
    <% } %>
    <a href="/posts?category=<%= category %>">목록으로 돌아가기</a>

    <hr>

    <% if (!(boardSetting && boardSetting.hideComments)) { %>
        <ul>
            <% comments.forEach(comment => { %>
                <% if (!comment.parentId) { %>
                    <li>
                        <% if (comment.author && !(boardSetting && boardSetting.hideCommentAuthor)) { %>
                            <strong><%= comment.author.username %></strong>:
                        <% } %>
                        <span class="comment-content"><%= comment.content %></span>
                        <% if (!(boardSetting && boardSetting.hideCommentDate)) { %> 
                            (작성일: <%= comment.createdAt.toDateString() %>)
                        <% } %>
                        <% if (comment.author && (user && (user.role === 'admin' || user.role === 'superadmin' || user.id === comment.author._id.toString()))) { %>
                            <form action="/posts/<%= post._id %>/comments/<%= comment._id %>/delete?category=<%= category %>" method="POST" style="display:inline;" onsubmit="return confirmCommentDelete();">
                                <button type="submit">삭제</button>
                            </form>
                            <button onclick="toggleEditForm('<%= comment._id %>')">수정</button>
                            <form id="edit-form-<%= comment._id %>" action="/posts/<%= post._id %>/comments/<%= comment._id %>/edit?category=<%= category %>" method="POST" style="display:none;">
                                <input type="text" name="content" value="<%= comment.content %>" required>
                                <button type="submit">완료</button>
                                <button type="button" onclick="toggleEditForm('<%= comment._id %>')">취소</button>
                            </form>
                        <% } %>
                        <button onclick="toggleReplyForm('<%= comment._id %>')">답글 달기</button>
                        
                        <!-- 답글 목록 -->
                        <ul style="margin-left: 0px;">
                            <% comments.forEach(reply => { %>
                                <% if (reply.parentId && reply.parentId.equals(comment._id)) { %>
                                    <li>
                                        <strong><%= reply.author.username %></strong>: <span class="comment-content"><%= reply.content %></span>
                                        <% if (user && (user.role === 'admin' || user.role === 'superadmin' || user.id === reply.author._id.toString())) { %>
                                            <form action="/posts/<%= post._id %>/comments/<%= reply._id %>/delete?category=<%= category %>" method="POST" style="display:inline;" onsubmit="return confirmCommentDelete();">
                                                <button type="submit">삭제</button>
                                            </form>
                                            <button onclick="toggleReplyEditForm('<%= reply._id %>')">수정</button>
                                            <form id="reply-edit-form-<%= reply._id %>" action="/posts/<%= post._id %>/comments/<%= reply._id %>/edit?category=<%= category %>" method="POST" style="display:none;">
                                                <input type="text" name="content" value="<%= reply.content %>" required>
                                                <button type="submit">완료</button>
                                                <button type="button" onclick="toggleReplyEditForm('<%= reply._id %>')">취소</button>
                                            </form>
                                        <% } %>
                                        <% if (!(boardSetting && boardSetting.hideCommentDate)) { %> 
                                            (작성일: <%= reply.createdAt.toDateString() %>)
                                        <% } %>
                                    </li>
                                <% } %>
                            <% }); %>
                        </ul>

                        <!-- 답글 입력 폼 -->
                        <form id="reply-form-<%= comment._id %>" action="/posts/<%= post._id %>/comments?category=<%= category %>" method="POST" style="display:none; margin-left: 20px;">
                            <input type="text" name="content" required placeholder="답글을 입력하세요">
                            <input type="hidden" name="parentId" value="<%= comment._id %>">
                            <button type="submit">답글 달기</button>
                        </form>
                    </li>
                <% } %>
            <% }); %>
        </ul>                

        <% if (user && boardSetting && commentPermission) { %>
            <form action="/posts/<%= post._id %>/comments?category=<%= category %>" method="POST">
                <textarea name="content" required></textarea>
                <button type="submit">댓글 달기</button>
            </form>
        <% } else { %>
            <p>댓글을 달 수 있는 권한이 없습니다.</p>
        <% } %>
    <% } %>

    <script>
        function toggleEditForm(commentId) {
            const form = document.getElementById('edit-form-' + commentId);
            const contentSpan = form.previousElementSibling;
            if (form.style.display === 'none') {
                form.style.display = 'inline';
                contentSpan.style.display = 'none';
            } else {
                form.style.display = 'none';
                contentSpan.style.display = 'inline';
            }
        }

        function toggleReplyForm(commentId) {
            const form = document.getElementById('reply-form-' + commentId);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }

        function toggleReplyEditForm(replyId) {
            const form = document.getElementById('reply-edit-form-' + replyId);
            const contentSpan = form.previousElementSibling;
            if (form.style.display === 'none') {
                form.style.display = 'inline';
                contentSpan.style.display = 'none';
            } else {
                form.style.display = 'none';
                contentSpan.style.display = 'inline';
            }
        }
    </script> 
</body>
</html>
